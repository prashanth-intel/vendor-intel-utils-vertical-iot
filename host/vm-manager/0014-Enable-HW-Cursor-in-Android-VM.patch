From 776f6e7c76545d6a10aa0eaf40393e10cc7624af Mon Sep 17 00:00:00 2001
From: Your Name <you@example.com>
Date: Tue, 22 Oct 2024 22:27:16 +0530
Subject: [PATCH] Enable HW Cursor in Android VM

Add configurable parameter in VM-manager

Tracked-On: OAM-126590
Signed-off-by: Suresh, Prashanth <prashanth.suresh@intel.com>
---
 src/guest/config_parser.cc   |  2 +-
 src/guest/config_parser.h    |  1 +
 src/guest/vm_builder_qemu.cc | 13 ++++++++++---
 3 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/src/guest/config_parser.cc b/src/guest/config_parser.cc
index c8fb5bc..000ba4a 100644
--- a/src/guest/config_parser.cc
+++ b/src/guest/config_parser.cc
@@ -35,7 +35,7 @@ map<string_view, vector<string_view>> kConfigMap = {
     { kGroupFirm,    { kFirmType, kFirmPath, kFirmCode, kFirmVars } },
     { kGroupDisk,    { kDiskSize, kDiskPath } },
     { kGroupVgpu,    { kVgpuType, kVgpuGvtgVer, kVgpuUuid, kVgpuMonId, kVgpuOutputs } },
-    { kGroupDisplay, { kDispOptions, kDispConnector0, kDispConnector1, kDispShowFps, kDisableHostInput, kHwSpice, kHwSpiceIp, kHwSpicePort } },
+    { kGroupDisplay, { kDispOptions, kDispConnector0, kDispConnector1, kDispShowFps, kDisableHostInput, kHwSpice, kHwSpiceIp, kHwSpicePort, kHwCursor } },
     { kGroupNet,     { kNetModel, kNetAdbPort, kNetFastbootPort } },
     { kGroupVtpm,    { kVtpmBinPath, kVtpmDataDir } },
     { kGroupRpmb,    { kRpmbBinPath, kRpmbDataDir } },
diff --git a/src/guest/config_parser.h b/src/guest/config_parser.h
index 7be9848..d7553aa 100644
--- a/src/guest/config_parser.h
+++ b/src/guest/config_parser.h
@@ -68,6 +68,7 @@ constexpr char kDisableHostInput[] = "disable_host_input";
 constexpr char kHwSpice[]  = "hw_spice";
 constexpr char kHwSpiceIp[] = "ip_addr";
 constexpr char kHwSpicePort[] = "port";
+constexpr char kHwCursor[]  = "hw_cursor";
 
 constexpr char kNetModel[] = "model";
 constexpr char kNetAdbPort[] = "adb_port";
diff --git a/src/guest/vm_builder_qemu.cc b/src/guest/vm_builder_qemu.cc
index 32b3fb9..d307878 100644
--- a/src/guest/vm_builder_qemu.cc
+++ b/src/guest/vm_builder_qemu.cc
@@ -350,6 +350,14 @@ bool VmBuilderQemu::SetupSriov(void) {
         emul_cmd_.append(" -display gtk,gl=on,monitor=" + vgpu_mon_id);
     }
 
+    std::string hw_cursor = cfg_.GetValue(kGroupDisplay, kHwCursor);
+    if((!hw_cursor.empty()) && hw_cursor.compare("true") == 0) {
+        LOG(info) << "Enabling hw cursor";
+        emul_cmd_.append(",hw-cursor=true");
+    } else {
+        emul_cmd_.append(",hw-cursor=false");
+    }
+
     int numberOfDisplays = 0;
     std::string connectors_0 = cfg_.GetValue(kGroupDisplay, kDispConnector0);
     std::string connectors_1 = cfg_.GetValue(kGroupDisplay, kDispConnector1);
@@ -416,15 +424,14 @@ bool VmBuilderQemu::SetupSriov(void) {
     std::string spice_port = cfg_.GetValue(kGroupDisplay, kHwSpicePort);
     if((!hw_spice.empty()) && hw_spice.compare("true") == 0) {
         LOG(info) << "Enabling hw spice display";
-        emul_cmd_.append(" -device virtio-gpu-pci,max_outputs=" + ((numberOfDisplays > 0 ) ? std::to_string(numberOfDisplays) : "1") + ",blob=true"
+        emul_cmd_.append(" -device virtio-gpu-pci,max_outputs=" + ((numberOfDisplays > 0 ) ? std::to_string(numberOfDisplays) : "1") + ",blob=true,render_sync=true"
                     ",xres=1920,yres=1080" +
                     " -device vfio-pci,host=0000:00:02." + std::to_string(vf) +
                     " -object memory-backend-memfd,hugetlb=on,id=mem_sriov,size=" + mem_size +
                     " -machine memory-backend=mem_sriov");
-
         emul_cmd_.append(" -spice gl=on,addr=" + spice_ip + ",port=" + spice_port  + ",disable-ticketing=on,streaming-video=filter,preferred-codec=gstreamer:h264");
     } else {
-        emul_cmd_.append(" -device virtio-vga,max_outputs=" + ((numberOfDisplays > 0 ) ? std::to_string(numberOfDisplays) : "1") + ",blob=true,render_sync=false"
+        emul_cmd_.append(" -device virtio-vga,max_outputs=" + ((numberOfDisplays > 0 ) ? std::to_string(numberOfDisplays) : "1") + ",blob=true,render_sync=true"
                     " -device vfio-pci,host=0000:00:02." + std::to_string(vf) +
                     " -object memory-backend-memfd,hugetlb=on,id=mem_sriov,size=" + mem_size +
                     " -machine memory-backend=mem_sriov");
-- 
2.43.0

